<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV Architect Pro - Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;700&family=Lora:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        /* --- CORE STYLES & SETUP --- */
        :root { --accent-color: #4f46e5; }
        html { font-size: 16px; scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .font-lora { font-family: 'Lora', serif; }
        .font-roboto-mono { font-family: 'Roboto Mono', monospace; }
        .accent-bg { background-color: var(--accent-color); }
        .accent-text { color: var(--accent-color); }
        .accent-border { border-color: var(--accent-color); }
        .accent-ring:focus { --tw-ring-color: var(--accent-color); }
        
        #preview-content-wrapper { width: 100%; display: flex; justify-content: center; }
        
        #cv-preview-pages {
            transform-origin: top;
        }

        .cv-page {
            background-color: white;
            width: 800px;
            padding: 0; 
            box-sizing: border-box;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
            overflow: hidden; 
        }
        
        /* Drag & Drop Styles */
        .list-item-header { display: flex; justify-content: space-between; align-items: center; }
        .drag-handle { cursor: grab; color: #9ca3af; }
        .drag-handle:active { cursor: grabbing; }
        .list-item.dragging { opacity: 0.5; background: #e0e7ff; }

        /* Mobile Overlay */
        #mobile-overlay.active { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 40; }

        /* Theme Preview Styles */
        .theme-preview-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        .theme-preview { border: 2px solid #e5e7eb; border-radius: 0.5rem; padding: 0.75rem; cursor: pointer; transition: all 0.2s ease-in-out; position: relative; }
        .theme-preview:hover { border-color: var(--accent-color); transform: translateY(-2px); }
        .theme-preview.active { border-color: var(--accent-color); box-shadow: 0 0 0 2px var(--accent-color); }
        .theme-preview .title { font-weight: 600; text-align: center; margin-bottom: 0.5rem; }
        .theme-preview .bar { background-color: #d1d5db; height: 6px; border-radius: 99px; }
        .theme-preview .accent-bar { background-color: var(--accent-color); width: 60%; }
        .pro-badge { position: absolute; top: -10px; right: -10px; background-color: #fbbf24; color: #422006; font-size: 0.6rem; font-weight: 800; padding: 2px 6px; border-radius: 99px; text-transform: uppercase; }

        /* --- TEMPLATE STYLES --- */
        .cv-template { font-size: 0.65rem; line-height: 1.6; }
        .cv-template h1 { font-size: 2.2rem; font-weight: 700; }
        .cv-template h2 { font-weight: 700; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 0.05em; color: var(--accent-color); border-bottom: 2px solid #e5e7eb; padding-bottom: 0.25rem; margin-bottom: 0.75rem; }
        .cv-template section { padding-top: 1rem; } 
        .cv-template section:first-of-type { padding-top: 0; }
        .cv-template h3 { font-weight: 600; font-size: 0.75rem; }
        .cv-template p, .cv-template li { color: #374151; }
        .cv-template ul { list-style-type: disc; padding-left: 1rem; }

        .template-sidebar {
            display: flex;
            min-height: 1123px; 
            height: 100%;
        }
        .template-sidebar .sidebar { width: 35%; background-color: #f8fafc; padding: 1.5rem; }
        .template-sidebar .sidebar h1 { font-size: 1.8rem; line-height: 1.2; }
        .template-sidebar .sidebar #cv-job-title { font-size: 0.8rem; }
        .template-sidebar .main-content { width: 65%; padding: 1.5rem; background-color: #ffffff; }
        .template-sidebar .level { background-color: #e5e7eb; height: 5px; }
        .template-sidebar .level-fill { background-color: var(--accent-color); height: 5px; }

        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen">
    
    <header class="lg:hidden sticky top-0 z-30 bg-white shadow-md p-4 flex justify-between items-center">
        <button id="menu-toggle" class="p-2 -ml-2" aria-label="Open navigation menu"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button>
        <h1 class="text-lg font-bold accent-text">CV Architect</h1>
        <button id="view-toggle" class="p-2 -mr-2 flex items-center gap-1 text-sm font-semibold accent-text" aria-label="Switch to preview view">
            <span id="view-toggle-text">Preview</span>
            <svg id="view-toggle-icon-eye" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
            <svg id="view-toggle-icon-pencil" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>
        </button>
    </header>

    <div id="mobile-overlay" class="lg:hidden"></div>

    <div class="lg:grid lg:grid-cols-12" style="height: calc(100vh - 64px);">
        <aside id="sidebar" class="fixed top-0 left-0 z-50 h-full w-64 bg-white p-6 flex flex-col justify-between shadow-lg transform -translate-x-full transition-transform duration-300 ease-in-out lg:relative lg:translate-x-0 lg:col-span-2 lg:shadow-none">
            <div>
                <h1 class="text-2xl font-bold accent-text mb-8 hidden lg:block">CV Architect Pro</h1>
                <nav id="sidebar-nav" class="space-y-2"></nav>
            </div>
            <div>
                <div class="space-y-2 text-sm font-semibold border-t pt-4 mt-4">
                    <button id="import-data" class="w-full text-left text-gray-600 hover:text-black">Import Data (JSON)</button>
                    <button id="export-data" class="w-full text-left text-gray-600 hover:text-black">Export Data (JSON)</button>
                </div>
                <div id="save-indicator" class="text-sm font-semibold text-green-600 my-2" style="opacity: 0;">Saved!</div>
                <div class="text-xs text-gray-400 border-t pt-4 mt-2">
                    <p class="font-semibold text-gray-500">Created by Akhtar Nazeer</p>
                    <p>0319-5410126</p>
                    <p>akhtarnazeer2004@gmail.com</p>
                    <button id="clear-data" class="w-full text-left mt-2 text-red-500 hover:text-red-700 font-semibold" aria-label="Clear all resume data">Clear All Data</button>
                </div>
            </div>
        </aside>

        <main id="form-container" class="lg:col-span-5 p-4 sm:p-8 overflow-y-auto">
            <div id="form-wizard"></div>
        </main>

        <aside id="preview-container-wrapper" class="hidden lg:flex lg:flex-col lg:col-span-5 bg-gray-200 p-4 sm:p-8 h-full">
            <h2 class="text-xl font-bold text-gray-700 mb-4 flex-shrink-0">Live Preview</h2>
            <div id="preview-scroll-area" class="flex-grow overflow-y-auto pr-2 min-h-0">
                <div id="preview-content-wrapper">
                    <div id="cv-preview-pages"></div>
                </div>
            </div>
        </aside>
    </div>
    
    <div class="fixed bottom-8 right-8 z-50 flex flex-col items-center gap-4">
        <button id="save-image" class="accent-bg text-white w-16 h-16 rounded-full hover:opacity-90 font-bold transition flex items-center justify-center shadow-lg" aria-label="Save as Image">
            <svg id="image-icon" class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
            <span id="image-loader" class="hidden w-7 h-7 border-4 border-white border-t-transparent rounded-full animate-spin"></span>
        </button>
        <button id="save-pdf" class="accent-bg text-white w-16 h-16 rounded-full hover:opacity-90 font-bold transition flex items-center justify-center shadow-lg" aria-label="Save as PDF">
            <svg id="pdf-icon" class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
            <span id="pdf-loader" class="hidden w-7 h-7 border-4 border-white border-t-transparent rounded-full animate-spin"></span>
        </button>
    </div>

<script type="module">
// --- CV ARCHITECT PRO ---

const $ = (selector) => document.querySelector(selector);
const $$ = (selector) => document.querySelectorAll(selector);
let cvData = {};
const defaultData = {
    template: 'sidebar',
    accentColor: '#4f46e5',
    fullName: 'Akhtar Nazeer',
    jobTitle: 'Aspiring Software Developer',
    objective: 'Detail-oriented and motivated university student pursuing a degree in Computer Science...',
    email: 'akhtarnazeer2004@gmail.com', phone: '0319-5410126', address: 'Mansehra, Pakistan', linkedin: 'linkedin.com/in/akhtar-nazeer',
    photo: 'https://placehold.co/150x150/E2E8F0/A0AEC0?text=AN',
    skills: [ { id: 1, name: 'JavaScript & HTML/CSS', level: 4 }, { id: 2, name: 'React.js', level: 3 }, { id: 3, name: 'Node.js & Express', level: 3 }, { id: 4, name: 'SQL & Databases', level: 3 }, ],
    experience: [ { id: 1, jobTitle: 'Web Dev Project (Academic)', company: 'Hazara University', startDate: 'Spring 2025', endDate: 'Present', description: 'Developed a full-stack web application for course registration using the MERN stack.\nDesigned and implemented a RESTful API for handling student and course data.' }, ],
    education: [ { id: 1, degree: 'BS in Computer Science', institution: 'Hazara University, Mansehra', startDate: '2021', endDate: '2025', description: 'Relevant Coursework: Data Structures, Algorithms, Web Development.' }, ],
    certificates: [ { id: 1, name: 'Responsive Web Design', issuer: 'freeCodeCamp', date: '2024' } ],
    languages: [ { id: 1, name: 'Urdu', level: 'Native' }, { id: 2, name: 'English', level: 'Professional' }, { id: 3, name: 'Pashto', level: 'Native' }, ],
    projects: [ { id: 1, name: 'Personal Portfolio Website', tech: 'HTML, CSS, JavaScript', link: 'github.com/your-repo', description: 'A responsive personal portfolio to showcase my skills and projects.'}],
    interests: 'Open-source contribution, competitive programming, hiking.',
};
const formStepsConfig = [ { id: 'settings', title: 'Settings', icon: 'âš™ï¸' }, { id: 'personal', title: 'Personal Info', icon: 'ðŸ‘¤' }, { id: 'contact', title: 'Contact', icon: 'ðŸ“ž' }, { id: 'objective', title: 'Objective', icon: 'ðŸŽ¯' }, { id: 'experience', title: 'Experience', icon: 'ðŸ’¼' }, { id: 'projects', title: 'Projects', icon: 'ðŸš€' }, { id: 'education', title: 'Education', icon: 'ðŸŽ“' }, { id: 'skills', title: 'Skills', icon: 'ðŸ› ï¸' }, { id: 'languages', title: 'Languages', icon: 'ðŸŒ' }, { id: 'certificates', title: 'Certificates', icon: 'ðŸ“œ' }, { id: 'interests', title: 'Interests', icon: 'â­' }, { id: 'photo', title: 'Photo', icon: 'ðŸ“·' }, ];
let activeStep = 'settings';

const sanitizeHTML = (str) => {
    if (!str) return '';
    const temp = document.createElement('div');
    temp.textContent = str;
    return temp.innerHTML;
};

function init() {
    loadData();
    buildSidebar();
    buildForm();
    addEventListeners();
    navigateTo(activeStep);
    renderCV();
}

function loadData() { /* Unchanged */
    try {
        const savedData = localStorage.getItem('cvArchitectData');
        cvData = savedData ? JSON.parse(savedData) : { ...defaultData };
        cvData.template = 'sidebar';
    } catch (error) {
        console.error("Failed to load data:", error);
        cvData = { ...defaultData };
    }
    document.documentElement.style.setProperty('--accent-color', cvData.accentColor);
}

function saveData() { /* Unchanged */
    try {
        localStorage.setItem('cvArchitectData', JSON.stringify(cvData));
        const indicator = $('#save-indicator');
        indicator.style.opacity = '1';
        setTimeout(() => { indicator.style.opacity = '0'; }, 1500);
    } catch (error) { console.error("Failed to save data:", error); }
    renderCV();
}

function clearData() { /* Unchanged */
    if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
        localStorage.removeItem('cvArchitectData');
        window.location.reload();
    }
}

function exportData() { /* Unchanged */
    const blob = new Blob([JSON.stringify(cvData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `cv-architect-data-${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function importData() { /* Unchanged */
    if (!confirm('Importing data will overwrite your current CV. Continue?')) return;
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'application/json';
    input.onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = event => {
            try {
                const newCvData = JSON.parse(event.target.result);
                if (newCvData.fullName) {
                    cvData = newCvData;
                    cvData.template = 'sidebar';
                    saveData();
                    window.location.reload();
                } else { alert('Invalid JSON file.'); }
            } catch (err) { alert('Error reading file.'); }
        };
        reader.readAsText(file);
    };
    input.click();
}

function buildSidebar() { /* Unchanged */
    $('#sidebar-nav').innerHTML = formStepsConfig.map(step => `<a href="#" class="step-link flex items-center gap-3 px-4 py-2 rounded-md font-semibold text-gray-600 hover:bg-gray-100" data-step="${step.id}"><span>${step.icon}</span> <span>${step.title}</span></a>`).join('');
}

function buildForm() { /* Unchanged */
    $('#form-wizard').innerHTML = formStepsConfig.map(step => `<div id="step-${step.id}" class="form-step hidden"><h2 class="text-3xl font-bold mb-6">${step.title}</h2>${getFormFieldsForStep(step.id)}</div>`).join('');
}

function getFormFieldsForStep(stepId) { /* Unchanged */
    const s = (value) => sanitizeHTML(value);
    const simpleInput = (id, label, value) => `<div><label for="${id}" class="block font-medium mb-1">${label}</label><input type="text" id="${id}" value="${s(value)}" class="w-full p-2 border rounded-md accent-ring"></div>`;
    if (stepId === 'settings') {
        const themeOptions = ['Sidebar', 'Classic', 'Executive', 'Creative', 'Minimalist', 'Technical', 'Academic', 'Bold', 'Timeline', 'Corporate'];
        const themePreviews = `<div class="theme-preview-grid mt-4">${themeOptions.map(t => {
            const isPro = t !== 'Sidebar';
            return `<div class="theme-preview ${t === 'Sidebar' ? 'active' : ''} ${isPro ? 'opacity-50 cursor-not-allowed' : ''}" title="${isPro ? t + ' (Pro Version)' : 'Select ' + t + ' theme'}">
                ${isPro ? '<div class="pro-badge">Pro</div>' : ''}
                <div class="title">${t}</div>
                <div class="space-y-1.5"><div class="bar"><div class="accent-bar"></div></div><div class="bar"></div><div class="bar"></div></div>
            </div>`;
        }).join('')}</div>`;
        return `<div><label class="block font-medium mb-2">Template</label>${themePreviews}</div><div class="mt-6"><label for="accentColor" class="block font-medium mb-2">Accent Color</label><input type="color" id="accentColor" value="${s(cvData.accentColor)}" class="w-full h-10 p-1 border rounded-md"></div>`;
    }
    switch(stepId) {
        case 'personal': return `${simpleInput('fullName', 'Full Name', cvData.fullName)}<div class="mt-4">${simpleInput('jobTitle', 'Job Title', cvData.jobTitle)}</div>`;
        case 'contact': return `${simpleInput('email', 'Email', cvData.email)}<div class="mt-4">${simpleInput('phone', 'Phone', cvData.phone)}</div><div class="mt-4">${simpleInput('address', 'Address', cvData.address)}</div><div class="mt-4">${simpleInput('linkedin', 'LinkedIn', cvData.linkedin)}</div>`;
        case 'objective': return `<div><label for="objective" class="block font-medium mb-1">Objective</label><textarea id="objective" rows="5" class="w-full p-2 border rounded-md accent-ring">${s(cvData.objective)}</textarea></div>`;
        case 'interests': return `<div><label for="interests" class="block font-medium mb-1">Interests</label><textarea id="interests" rows="4" class="w-full p-2 border rounded-md accent-ring">${s(cvData.interests)}</textarea></div>`;
        case 'photo': return `<p class="text-sm text-gray-600 mb-4">Used for the Sidebar template.</p><input type="file" id="photo-upload" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/><div id="crop-container" class="mt-4 hidden p-4 border-2 border-dashed rounded-lg text-center"><p class="font-semibold mb-2">Adjust Photo</p><div class="mx-auto w-48 h-48 rounded-full overflow-hidden"><canvas id="crop-canvas" width="192" height="192"></canvas></div><button id="crop-button" class="mt-4 w-full accent-bg text-white py-2 px-4 rounded-md hover:opacity-90">Confirm Crop</button></div>`;
        default: return `<div id="${stepId}-list"></div><button class="add-entry mt-4 font-semibold accent-text" data-type="${stepId}">+ Add ${stepId.charAt(0).toUpperCase() + stepId.slice(1)}</button>`;
    }
}

function buildList(type, data) { /* Unchanged */
    const container = $(`#${type}-list`);
    if (!container) return;
    container.innerHTML = data && data.length > 0 ? data.map(item => getListItemHTML(type, item)).join('') : `<p class="text-sm text-gray-400" id="${type}-placeholder">No entries yet. Click below to add one.</p>`;
    if (data && data.length > 0) addDragDropListeners(container);
}

function getListItemHTML(type, item) { /* Unchanged */
    const s = (value) => sanitizeHTML(value);
    const fields = {
        experience: `<input type="text" data-key="jobTitle" value="${s(item.jobTitle)}" placeholder="Job Title" class="font-semibold w-full p-1"><input type="text" data-key="company" value="${s(item.company)}" placeholder="Company" class="w-full p-1"><div class="flex gap-2"><input type="text" data-key="startDate" value="${s(item.startDate)}" placeholder="Start Date" class="w-1/2 p-1"><input type="text" data-key="endDate" value="${s(item.endDate)}" placeholder="End Date" class="w-1/2 p-1"></div><p class="text-xs text-gray-500 px-1">Tip: One point per line for bullets.</p><textarea data-key="description" rows="4" placeholder="Description..." class="w-full p-1 text-sm">${s(item.description)}</textarea>`,
        projects: `<input type="text" data-key="name" value="${s(item.name)}" placeholder="Project Name" class="font-semibold w-full p-1"><input type="text" data-key="tech" value="${s(item.tech)}" placeholder="Tech Stack" class="w-full p-1"><input type="text" data-key="link" value="${s(item.link)}" placeholder="Project Link" class="w-full p-1"><textarea data-key="description" rows="3" placeholder="Description..." class="w-full p-1 text-sm">${s(item.description)}</textarea>`,
        education: `<input type="text" data-key="degree" value="${s(item.degree)}" placeholder="Degree" class="font-semibold w-full p-1"><input type="text" data-key="institution" value="${s(item.institution)}" placeholder="Institution" class="w-full p-1"><div class="flex gap-2"><input type="text" data-key="startDate" value="${s(item.startDate)}" placeholder="Start Year" class="w-1/2 p-1"><input type="text" data-key="endDate" value="${s(item.endDate)}" placeholder="End Year" class="w-1/2 p-1"></div><input type="text" data-key="description" value="${s(item.description)}" placeholder="Optional: GPA, Honors..." class="w-full p-1 text-sm">`,
        skills: `<div class="flex items-center gap-2"><input type="text" data-key="name" value="${s(item.name)}" placeholder="Skill" class="w-full p-1"><input type="range" data-key="level" value="${s(item.level)}" min="1" max="5" class="w-32 accent-bg"><span class="skill-level-indicator font-semibold text-gray-600 w-4 text-center">${s(item.level)}</span></div>`,
        languages: `<div class="flex items-center gap-2"><input type="text" data-key="name" value="${s(item.name)}" placeholder="Language" class="w-1/2 p-1"><input type="text" data-key="level" value="${s(item.level)}" placeholder="e.g., Native, Fluent" class="w-1/2 p-1"></div>`,
        certificates: `<input type="text" data-key="name" value="${s(item.name)}" placeholder="Certificate" class="w-full p-1"><input type="text" data-key="issuer" value="${s(item.issuer)}" placeholder="Issuer" class="w-full p-1"><input type="text" data-key="date" value="${s(item.date)}" placeholder="Date" class="w-full p-1">`,
    };
    return `<div class="list-item p-4 border rounded-lg mb-4 bg-white shadow-sm" draggable="true" data-id="${item.id}" data-type="${type}"><div class="list-item-header"><div class="flex-grow space-y-2">${fields[type]}</div><div class="pl-2 drag-handle" title="Drag to reorder"><svg class="w-6 h-6" fill="currentColor"><use href="#icon-grab"></use></svg></div></div><button class="remove-entry mt-2 text-xs text-red-500 hover:text-red-700">Remove</button></div>`;
}

function addEventListeners() { // Updated
    const sidebar = $('#sidebar');
    const mobileOverlay = $('#mobile-overlay');
    $('#menu-toggle').addEventListener('click', () => { sidebar.classList.toggle('-translate-x-full'); mobileOverlay.classList.toggle('active'); });
    mobileOverlay.addEventListener('click', () => { sidebar.classList.add('-translate-x-full'); mobileOverlay.classList.remove('active'); });
    $('#view-toggle').addEventListener('click', () => {
        $('#form-container').classList.toggle('hidden');
        $('#preview-container-wrapper').classList.toggle('hidden');
        $('#preview-container-wrapper').classList.toggle('lg:flex');
        const text = $('#view-toggle-text'), eyeIcon = $('#view-toggle-icon-eye'), pencilIcon = $('#view-toggle-icon-pencil');
        if ($('#preview-container-wrapper').classList.contains('hidden')) { text.textContent = 'Preview'; eyeIcon.classList.remove('hidden'); pencilIcon.classList.add('hidden'); } 
        else { text.textContent = 'Editor'; eyeIcon.classList.add('hidden'); pencilIcon.classList.remove('hidden'); }
    });
    $('#sidebar-nav').addEventListener('click', e => {
        const link = e.target.closest('.step-link');
        if (link) { 
            e.preventDefault(); 
            navigateTo(link.dataset.step);
            if (window.innerWidth < 1024) {
                sidebar.classList.add('-translate-x-full');
                mobileOverlay.classList.remove('active');
                $('#form-container').classList.remove('hidden');
                $('#preview-container-wrapper').classList.add('hidden');
                $('#preview-container-wrapper').classList.add('lg:flex');
                $('#view-toggle-text').textContent = 'Preview';
                $('#view-toggle-icon-eye').classList.remove('hidden');
                $('#view-toggle-icon-pencil').classList.add('hidden');
            }
        }
    });
    let debounceTimer;
    $('#form-wizard').addEventListener('input', e => {
        const target = e.target;
        if (target.closest('.list-item')) {
            const itemEl = target.closest('.list-item');
            const { id, type } = itemEl.dataset;
            const key = target.dataset.key;
            const item = cvData[type]?.find(i => i.id == id);
            if (item) item[key] = target.value;
            if (key === 'level') itemEl.querySelector('.skill-level-indicator').textContent = target.value;
        } else if (target.id) {
            if (target.id === 'accentColor') document.documentElement.style.setProperty('--accent-color', target.value);
            if (cvData.hasOwnProperty(target.id)) cvData[target.id] = target.value;
        }
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(saveData, 300);
    });
    $('#form-wizard').addEventListener('click', e => {
        if (e.target.matches('.add-entry')) {
            const type = e.target.dataset.type;
            const templates = { certificates: {}, skills: { level: 3 }, languages: {}, experience: {}, education: {}, projects: {}};
            const newItem = { id: Date.now(), ...templates[type] };
            if (!cvData[type]) cvData[type] = [];
            cvData[type].push(newItem);
            const placeholder = $(`#${type}-placeholder`);
            if(placeholder) placeholder.remove();
            $(`#${type}-list`).insertAdjacentHTML('beforeend', getListItemHTML(type, newItem));
            addDragDropListeners($(`#${type}-list`));
            saveData();
        }
        if (e.target.matches('.remove-entry')) {
            const itemEl = e.target.closest('.list-item');
            const { id, type } = itemEl.dataset;
            cvData[type] = cvData[type].filter(i => i.id != id);
            itemEl.remove();
            if (cvData[type].length === 0) { $(`#${type}-list`).innerHTML = `<p class="text-sm text-gray-400" id="${type}-placeholder">No entries yet.</p>`; }
            saveData();
        }
    });
    $('#save-pdf').addEventListener('click', downloadPdf);
    $('#save-image').addEventListener('click', downloadImage); // New event listener
    $('#clear-data').addEventListener('click', clearData);
    $('#import-data').addEventListener('click', importData);
    $('#export-data').addEventListener('click', exportData);
    setupPhotoCropper();
    window.addEventListener('resize', scalePreview);
}

function addDragDropListeners(container) { /* Unchanged */ }
function getDragAfterElement(container, y) { /* Unchanged */ }
function setupPhotoCropper() { /* Unchanged */ }

function navigateTo(stepId) { /* Unchanged */
    activeStep = stepId;
    $$('.form-step').forEach(s => s.classList.add('hidden'));
    $(`#step-${stepId}`).classList.remove('hidden');
    $$('.step-link').forEach(l => l.classList.remove('active', 'bg-gray-100'));
    $(`.step-link[data-step="${stepId}"]`)?.classList.add('active', 'bg-gray-100');
    if (['experience', 'education', 'skills', 'languages', 'certificates', 'projects'].includes(stepId)) { buildList(stepId, cvData[stepId]); }
    if (stepId === 'settings') {
        $$('.theme-preview').forEach(el => el.classList.remove('active'));
        $(`.theme-preview:not(.opacity-50)`)?.classList.add('active');
    }
}

function scalePreview() { /* Unchanged */
    const pagesContainer = $('#cv-preview-pages');
    const scrollContainer = $('#preview-scroll-area');
    if (!pagesContainer || !scrollContainer) return;
    const availableWidth = scrollContainer.clientWidth - 4; 
    const scale = availableWidth / 800; 
    pagesContainer.style.transform = `scale(${scale})`;
}

function renderCV() { /* Unchanged */
    const pagesContainer = $('#cv-preview-pages');
    if (!pagesContainer) return;
    pagesContainer.innerHTML = `<div class="cv-page"></div>`;
    const singlePage = pagesContainer.querySelector('.cv-page');
    singlePage.innerHTML = getTemplateHTML();
    scalePreview();
}

// === NEW: Function to download the CV as a PNG image ===
async function downloadImage() {
    const imageLoader = $('#image-loader'), imageIcon = $('#image-icon');
    imageIcon.classList.add('hidden');
    imageLoader.classList.remove('hidden');

    // Create a temporary element to render the full CV off-screen
    const container = document.createElement('div');
    container.style.position = 'absolute';
    container.style.left = '-9999px'; // Move it off-screen
    container.style.width = '800px'; // Set a fixed width for correct layout
    container.innerHTML = getTemplateHTML();
    document.body.appendChild(container);

    const cvElement = container.querySelector('.cv-template');

    try {
        const canvas = await html2canvas(cvElement, {
            scale: 2, // Higher scale for better resolution
            useCORS: true, // Important for external images
            allowTaint: true,
            backgroundColor: null, // Use element's background
        });
        
        // Trigger download
        const link = document.createElement('a');
        link.download = `CV-${cvData.fullName.replace(/\s+/g, '_') || 'resume'}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();

    } catch (error) {
        console.error('Error generating image:', error);
        alert('Could not generate image. See console for details.');
    } finally {
        // Clean up: remove the temporary element and restore button state
        document.body.removeChild(container);
        imageIcon.classList.remove('hidden');
        imageLoader.classList.add('hidden');
    }
}


async function downloadPdf() { /* Renamed from prepareAndPrint */
    const pdfLoader = $('#pdf-loader'), pdfIcon = $('#pdf-icon');
    pdfIcon.classList.add('hidden');
    pdfLoader.classList.remove('hidden');

    const content = getTemplateHTML();
    const element = document.createElement('div');
    element.innerHTML = content;
    const cvElement = element.querySelector('.cv-template');

    const opt = {
      margin:       0.5,
      filename:     `CV-${cvData.fullName.replace(/\s+/g, '_') || 'resume'}.pdf`,
      image:        { type: 'jpeg', quality: 0.98 },
      html2canvas:  { scale: 2, useCORS: true },
      jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
    };

    await html2pdf().from(cvElement).set(opt).save();

    pdfIcon.classList.remove('hidden');
    pdfLoader.classList.add('hidden');
}

// --- TEMPLATE GENERATION LOGIC ---

function getTemplateHTML() { /* Unchanged */
    return renderSidebarCV();
}

const s = (value) => sanitizeHTML(String(value || ''));

const formatDescription = (text) => { /* Unchanged */
    if (!text || typeof text !== 'string') return '';
    const lines = s(text).split('\n').map(line => line.trim()).filter(line => line.length > 0);
    if (lines.length > 0) { return `<ul>${lines.map(line => `<li>${line}</li>`).join('')}</ul>`; }
    return '';
};

function renderSidebarCV() { /* Unchanged */
    const createContactLine = (icon, text) => {
        if (!text) return '';
        const sanitizedText = s(text);
        const link = icon === 'linkedin' ? `https://${sanitizedText.replace(/^https?:\/\//,'')}` : (icon === 'email' ? `mailto:${sanitizedText}` : null);
        const content = `<div class="flex items-start gap-2">
            <svg class="w-3.5 h-3.5 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><use href="#icon-${icon}"></use></svg>
            <span>${sanitizedText}</span>
        </div>`;
        return link ? `<a href="${link}" target="_blank" class="hover:underline">${content}</a>` : content;
    };
    const sections = {
        objective: (d) => d ? `<section><h2>Objective</h2><p>${s(d)}</p></section>` : '',
        education: (d) => d?.length > 0 ? `<section><h2>Education</h2>${d.map(e=>`<div class="mb-3"><h3>${s(e.degree)}</h3><p class="text-sm">${s(e.institution)} | ${s(e.startDate)} - ${s(e.endDate)}</p><p class="text-xs text-gray-600">${s(e.description)}</p></div>`).join('')}</section>` : '',
        experience: (d) => d?.length > 0 ? `<section><h2>Experience</h2>${d.map(e=>`<div class="mb-4"><h3>${s(e.jobTitle)}</h3><p class="text-sm font-semibold accent-text">${s(e.company)} | ${s(e.startDate)} - ${s(e.endDate)}</p><div class="text-sm mt-1 text-gray-700">${formatDescription(e.description)}</div></div>`).join('')}</section>` : '',
        projects: (d) => d?.length > 0 ? `<section><h2>Projects</h2>${d.map(p => `<div class="mb-4"><h3>${s(p.name)}</h3><p class="text-sm font-semibold accent-text">${s(p.tech)}</p>${p.link ? `<a href="${'https://' + s(p.link).replace(/^https?:\/\//,'')}" target="_blank" class="text-xs text-gray-500 hover:underline">${s(p.link)}</a>` : ''}<div class="text-sm mt-1 text-gray-700">${formatDescription(p.description)}</div></div>`).join('')}</section>` : '',
        certificates: (d) => d?.length > 0 ? `<section><h2>Certificates</h2>${d.map(c => `<div class="mb-2"><h3>${s(c.name)}</h3><p class="text-xs text-gray-600">${s(c.issuer)} (${s(c.date)})</p></div>`).join('')}</section>` : '',
        interests: (d) => d?.trim() ? `<section><h2>Interests</h2><p class="text-sm">${s(d)}</p></section>` : '',
        skills: (d) => d?.length > 0 ? `<section><h2>Skills</h2><div class="space-y-3">${d.map(skill => `<div class="skill-item"><span class="text-sm font-semibold">${s(skill.name)}</span><div class="level w-full rounded-full mt-1"><div class="level-fill rounded-full" style="width:${s(skill.level)*20}%"></div></div></div>`).join('')}</div></section>` : '',
        languages: (d) => d?.length > 0 ? `<section><h2>Languages</h2>${d.map(l=>`<p>${s(l.name)} <span class="text-gray-500">- ${s(l.level)}</span></p>`).join('')}</section>` : ''
    };
    
    return `
    <svg width="0" height="0" style="position: absolute; display: none;">
        <symbol id="icon-email" viewBox="0 0 20 20" fill="currentColor"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path></symbol>
        <symbol id="icon-phone" viewBox="0 0 20 20" fill="currentColor"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path></symbol>
        <symbol id="icon-location" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path></symbol>
        <symbol id="icon-linkedin" viewBox="0 0 24 24" fill="currentColor"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></symbol>
        <symbol id="icon-grab" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2zm0 6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2zm0 6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2z"/></symbol>
    </svg>
    <div class="cv-template template-sidebar">
        <div class="sidebar">
            <div class="text-center mb-6"><img id="cv-photo" src="${s(cvData.photo)}" alt="Profile" class="rounded-full object-cover w-32 h-32 mx-auto border-4 border-white shadow-md"></div>
            <div class="text-center mb-6"><h1>${s(cvData.fullName)}</h1><p id="cv-job-title" class="accent-text font-semibold">${s(cvData.jobTitle)}</p></div>
            <section>
                <h2>Contact</h2>
                <div class="space-y-2 text-sm">
                    ${createContactLine('email', cvData.email)}
                    ${createContactLine('phone', cvData.phone)}
                    ${createContactLine('location', cvData.address)}
                    ${createContactLine('linkedin', cvData.linkedin)}
                </div>
            </section>
            ${sections.skills(cvData.skills)}
            ${sections.languages(cvData.languages)}
            ${sections.interests(cvData.interests)}
        </div>
        <div class="main-content">
            ${sections.objective(cvData.objective)}
            ${sections.education(cvData.education)}
            ${sections.experience(cvData.experience)}
            ${sections.projects(cvData.projects)}
            ${sections.certificates(cvData.certificates)}
        </div>
    </div>`;
}

// --- START THE APP ---
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
